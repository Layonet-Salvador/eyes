<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    
    <title>Robot AI V4 - TecNM Iztapalapa III</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.3/dist/face-landmarks-detection.min.js"></script>

    <style>
        /* --- VARIABLES DE COLOR DIN√ÅMICAS --- */
        :root {
            --main-color: #00ff9d; /* Verde por defecto */
            --glow-shadow: rgba(0, 255, 157, 0.3);
        }

        /* --- ESTILOS GENERALES --- */
        html, body {
            background-color: #000;
            color: white;
            margin: 0; padding: 0;
            height: 100dvh; width: 100vw; /* 100dvh para m√≥viles modernos */
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        /* --- PANTALLA 0: CONFIGURACI√ìN INICIAL --- */
        #config-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a;
            z-index: 300; /* Encima de todo */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .config-section { margin-bottom: 30px; text-align: center; }
        .config-title { font-size: 1.1rem; color: #888; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;}

        /* Selector de Color */
        .color-options { display: flex; gap: 15px; justify-content: center; }
        .color-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-btn.selected { border-color: white; transform: scale(1.1); }
        .c-green { background: #00ff9d; box-shadow: 0 0 15px #00ff9d;}
        .c-red { background: #ff0055; box-shadow: 0 0 15px #ff0055;}
        .c-blue { background: #00ccff; box-shadow: 0 0 15px #00ccff;}

        /* Selector de Modo */
        .mode-select {
            padding: 10px 20px;
            background: #222;
            color: white;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 1rem;
        }

        .btn-continue {
            background: var(--main-color);
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        /* --- PANTALLA 1: BRANDING (TecNM) --- */
        #intro-screen {
            display: none; /* Oculto hasta configurar */
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%);
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .tecnm-title { font-size: 1rem; color: #888; text-transform: uppercase; }
        .campus-title {
            font-size: 1.5rem; color: var(--main-color);
            font-weight: 800; margin-top: 10px;
            text-shadow: 0 0 20px var(--glow-shadow);
        }
        .btn-start-device {
            background: transparent;
            border: 2px solid var(--main-color);
            color: var(--main-color);
            padding: 18px 40px; font-size: 1.1rem; border-radius: 50px;
            cursor: pointer; margin: 10px 0; width: 80%; max-width: 300px;
            font-weight: bold; text-transform: uppercase;
        }

        /* --- PANTALLA 2: CARGA --- */
        #loading-screen {
            display: none;
            position: absolute; z-index: 150;
            width: 100%; height: 100%; background: #000;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .loader-ring {
            width: 50px; height: 50px;
            border: 4px solid #333; border-top: 4px solid var(--main-color);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- PANTALLA 3: ROBOT --- */
        #robot-container {
            display: none;
            width: 100%; height: 100%;
            position: relative; z-index: 10;
            align-items: center; justify-content: center;
        }

        .robot-face { display: flex; gap: 6vmin; position: relative;}

        .eye {
            width: 40vmin; height: 40vmin;
            max-width: 350px; max-height: 350px;
            background: radial-gradient(circle at 30% 30%, #222, #000);
            border: 0.8vmin solid var(--main-color);
            border-radius: 50%;
            box-shadow: 0 0 40px var(--glow-shadow), inset 0 0 30px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease;
        }

        .pupil {
            width: 30%; height: 30%;
            background: #fff; border-radius: 50%;
            box-shadow: 0 0 15px #fff, 0 0 50px var(--main-color);
            position: absolute; transition: transform 0.1s ease-out;
        }

        /* P√°rpados para animaci√≥n de sonrisa */
        .eyelid-top, .eyelid-bottom {
            position: absolute; left: 0; width: 100%;
            background: #000; z-index: 5;
            transition: height 0.3s ease-in-out;
        }
        .eyelid-top { top: 0; height: 0%; }
        .eyelid-bottom { bottom: 0; height: 0%; }

        /* Estado Feliz (Smile detected) */
        .robot-face.happy .eyelid-bottom { height: 45%; } /* Ojo se entorna desde abajo */

        /* --- BOTONES DISCRETOS (TOP RIGHT) --- */
        .top-controls {
            position: absolute;
            top: 20px; right: 20px;
            z-index: 500;
            display: flex; gap: 10px;
        }
        .discrete-btn {
            background: rgba(0,0,0,0.6);
            border: 1px solid #444; color: #888;
            width: 35px; height: 35px;
            border-radius: 6px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem;
        }
        .discrete-btn.active-debug { border-color: var(--main-color); color: var(--main-color); }

        /* Debug Canvas y Video Oculto */
        #debug-canvas {
            position: absolute; bottom: 20px; right: 20px;
            width: 120px; border: 1px solid var(--main-color);
            display: none; z-index: 100; background: #000; transform: scaleX(-1);
        }
        #video-hidden { position: absolute; opacity: 0; pointer-events: none; }

    </style>
</head>
<body>

    <div id="config-screen">
        <div class="tecnm-title">Configuraci√≥n Inicial</div>
        <h2 style="margin-top:0;">PERSONALIZA TU ROBOT</h2>

        <div class="config-section">
            <div class="config-title">1. Color de Ojos</div>
            <div class="color-options">
                <div class="color-btn c-green selected" onclick="selectColor('#00ff9d', this)"></div>
                <div class="color-btn c-red" onclick="selectColor('#ff0055', this)"></div>
                <div class="color-btn c-blue" onclick="selectColor('#00ccff', this)"></div>
            </div>
        </div>

        <div class="config-section">
            <div class="config-title">2. Modo de Reconocimiento</div>
            <select id="modeSelect" class="mode-select">
                <option value="basic">B√°sico (Solo Seguimiento)</option>
                <option value="smile">Avanzado (Detectar Sonrisas)</option>
            </select>
        </div>

        <button class="btn-continue" onclick="finishConfig()">CONTINUAR</button>
    </div>


    <div id="intro-screen">
        <div style="margin-bottom: 40px;">
            <div class="tecnm-title">Desarrollado por</div>
            <div class="tecnm-title" style="font-weight:bold; margin-top:5px; color:white;">Tecnol√≥gico Nacional de M√©xico</div>
            <div class="campus-title">Iztapalapa III</div>
        </div>
        <button class="btn-start-device" onclick="startSystem('mobile')">üì± Iniciar en Celular</button>
        <button class="btn-start-device" onclick="startSystem('pc')">üíª Iniciar en PC</button>
    </div>


    <div id="loading-screen">
        <div class="loader-ring"></div>
        <h3 id="loading-text" style="color:var(--main-color); font-size:0.9rem; letter-spacing:1px;">CARGANDO CEREBRO ARTIFICIAL...</h3>
        <p style="font-size: 0.7rem; opacity: 0.6;">Esto puede tardar unos segundos la primera vez.</p>
    </div>


    <div id="robot-container">
        <div class="robot-face" id="robot-face">
            <div class="eye">
                <div class="eyelid-top"></div><div class="eyelid-bottom"></div>
                <div class="pupil" id="p-left"></div>
            </div>
            <div class="eye">
                <div class="eyelid-top"></div><div class="eyelid-bottom"></div>
                <div class="pupil" id="p-right"></div>
            </div>
        </div>

        <div class="top-controls">
            <button class="discrete-btn" id="btn-debug" onclick="toggleDebug()">üì∑</button>
            <button class="discrete-btn" onclick="forceFullScreen()">‚õ∂</button>
        </div>
    </div>

    <video id="video-hidden" playsinline muted autoplay></video>
    <canvas id="debug-canvas"></canvas>

    <script>
        // --- VARIABLES GLOBALES ---
        let model = null;
        let video = document.getElementById('video-hidden');
        let pupilLeft = document.getElementById('p-left');
        let pupilRight = document.getElementById('p-right');
        let robotFace = document.getElementById('robot-face');
        let debugCanvas = document.getElementById('debug-canvas');
        let ctxDebug = debugCanvas.getContext('2d');
        
        // Estado
        let selectedColor = '#00ff9d';
        let detectSmiles = false;
        let isDebug = false;
        let isSystemRunning = false;

        // --- 1. L√ìGICA DE CONFIGURACI√ìN ---
        function selectColor(color, element) {
            selectedColor = color;
            // Actualizar UI visualmente
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            // Actualizar variables CSS din√°micamente
            document.documentElement.style.setProperty('--main-color', color);
            document.documentElement.style.setProperty('--glow-shadow', color + '4d'); // 4d es ~30% opacidad hex
        }

        function finishConfig() {
            detectSmiles = document.getElementById('modeSelect').value === 'smile';
            document.getElementById('config-screen').style.display = 'none';
            document.getElementById('intro-screen').style.display = 'flex';
            forceFullScreen();
        }

        // --- 2. INICIO DEL SISTEMA ---
        async function startSystem(deviceType) {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            const loadingText = document.getElementById('loading-text');

            // Configurar c√°mara seg√∫n dispositivo
            let constraints = {
                audio: false,
                video: {
                    facingMode: 'user',
                    width: { ideal: deviceType === 'mobile' ? 480 : 640 },
                    height: { ideal: deviceType === 'mobile' ? 640 : 480 }
                }
            };

            try {
                // A. C√°mara
                loadingText.innerText = "CONECTANDO SENSORES VISUALES...";
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                video.play();

                // B. Cargar Modelo IA (FaceMesh - Pesado pero preciso)
                loadingText.innerText = "CARGANDO RED NEURONAL (FACE MESH)...";
                // Usamos el modelo "mediapipe-facemesh" que es m√°s robusto para expresiones
                model = await faceLandmarksDetection.load(
                    faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
                    { maxFaces: 1 } // Solo una cara para optimizar
                );

                loadingText.innerText = "SISTEMA ONLINE";
                
                // C. Mostrar Robot
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('robot-container').style.display = 'flex';
                    isSystemRunning = true;
                    detectFrame(); // Iniciar bucle principal
                }, 800);

            } catch (err) {
                console.error(err);
                loadingText.innerText = "ERROR CR√çTICO DE C√ÅMARA";
                loadingText.style.color = "#ff0055";
                alert("Error: Aseg√∫rate de usar HTTPS y dar permisos de c√°mara.");
            }
        }

        // --- 3. BUCLE PRINCIPAL DE IA ---
        async function detectFrame() {
            if (!isSystemRunning) return;

            // Inferencia de la IA
            const predictions = await model.estimateFaces({ input: video });

            // Debugging visual
            if (isDebug) {
                debugCanvas.width = video.videoWidth;
                debugCanvas.height = video.videoHeight;
                ctxDebug.drawImage(video, 0, 0);
            }

            if (predictions.length > 0) {
                const face = predictions[0];
                
                // --- A. SEGUIMIENTO DE OJOS (Usando Bounding Box) ---
                const start = face.boundingBox.topLeft;
                const end = face.boundingBox.bottomRight;
                const faceX = start[0] + ((end[0] - start[0]) / 2);
                const faceY = start[1] + ((end[1] - start[1]) / 2);
                moveEyes(faceX, faceY);

                // --- B. DETECCI√ìN DE SONRISA (Usando Mesh Landmarks) ---
                if (detectSmiles) {
                    checkSmile(face.scaledMesh);
                }

                // Dibujar debug box
                if (isDebug) {
                    ctxDebug.strokeStyle = selectedColor;
                    ctxDebug.lineWidth = 4;
                    ctxDebug.strokeRect(start[0], start[1], end[0] - start[0], end[1] - start[1]);
                }

            } else {
                resetRobot();
            }

            requestAnimationFrame(detectFrame);
        }

        // --- 4. L√ìGICA DE SONRISA ---
        function checkSmile(mesh) {
            // √çndices clave de FaceMesh para la boca:
            // 61: Comisura izquierda, 291: Comisura derecha
            // 0: Labio superior central, 17: Labio inferior central
            const leftCorner = mesh[61];
            const rightCorner = mesh[291];
            const upperLip = mesh[0];
            const lowerLip = mesh[17];

            // Ancho de la boca
            const mouthWidth = Math.hypot(rightCorner[0] - leftCorner[0], rightCorner[1] - leftCorner[1]);
            // Centro de la boca en Y
            const mouthCenterY = (upperLip[1] + lowerLip[1]) / 2;
            // Altura promedio de las comisuras en Y
            const cornersY = (leftCorner[1] + rightCorner[1]) / 2;

            // C√°lculo simple de sonrisa:
            // Si las comisuras est√°n significativamente m√°s altas (menor valor Y) que el centro de la boca.
            // El umbral (0.1) es experimental, puede requerir ajustes.
            const smileRatio = (mouthCenterY - cornersY) / mouthWidth;
            
            // Umbral de sensibilidad para considerar que es una sonrisa
            const smileThreshold = 0.1; 

            if (smileRatio > smileThreshold) {
                robotFace.classList.add('happy'); // Activa la clase CSS que mueve los p√°rpados inferiores
            } else {
                robotFace.classList.remove('happy');
            }
        }

        // --- 5. MOVIMIENTO Y RESET ---
        function moveEyes(faceX, faceY) {
            const width = video.videoWidth;
            const height = video.videoHeight;
            const limit = 30; // Rango de movimiento %

            // Normalizar y Espejo en X
            let xPos = -((faceX / width) * 2 - 1);
            let yPos = (faceY / height) * 2 - 1;

            // Clamping
            let moveX = Math.max(Math.min(xPos * limit, limit), -limit);
            let moveY = Math.max(Math.min(yPos * limit, limit), -limit);

            pupilLeft.style.transform = `translate(${moveX}vmin, ${moveY}vmin)`;
            pupilRight.style.transform = `translate(${moveX}vmin, ${moveY}vmin)`;
        }

        function resetRobot() {
            pupilLeft.style.transform = `translate(0, 0)`;
            pupilRight.style.transform = `translate(0, 0)`;
            robotFace.classList.remove('happy');
        }

        // --- 6. UTILIDADES (Debug y Fullscreen) ---
        window.toggleDebug = function() {
            isDebug = !isDebug;
            debugCanvas.style.display = isDebug ? 'block' : 'none';
            document.getElementById('btn-debug').classList.toggle('active-debug');
        }

        window.forceFullScreen = function() {
            let elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen().catch(e=>{});
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        }
    </script>
</body>
</html>
